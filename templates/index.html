<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <!-- è®©ç§»åŠ¨ç«¯æ­£ç¡®ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyss' MD Store</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        function changeSort(sortBy) {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('sort_by') === sortBy) {
                let order = urlParams.get('order') || 'asc';
                order = (order === 'asc') ? 'desc' : 'asc';
                urlParams.set('order', order);
            } else {
                urlParams.set('sort_by', sortBy);
                urlParams.set('order', 'asc');
            }
            window.location.search = urlParams.toString();
        }

        function doSearch() {
            const keyword = document.getElementById('search_input').value;
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('search', keyword);
            window.location.search = urlParams.toString();
        }

        // å¼€å§‹ç¼–è¾‘
        function startEditing() {
            document.getElementById('file_content_view').style.display = 'none';
            document.getElementById('edit_button').style.display = 'none';
            document.getElementById('edit_controls').style.display = 'inline-block';
            document.getElementById('edit_form').style.display = 'block';
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEditing() {
            document.getElementById('file_content_view').style.display = 'block';
            document.getElementById('edit_button').style.display = 'inline-block';
            document.getElementById('edit_controls').style.display = 'none';
            document.getElementById('edit_form').style.display = 'none';
        }

        function confirmDelete() {
            return confirm('ç¡®è®¤åˆ é™¤å—ï¼Ÿ');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // æ‰¹é‡æ“ä½œ
            function attachBatchHandler(formId) {
                const form = document.getElementById(formId);
                if(!form) return;
                form.addEventListener('submit', async function(e){
                    e.preventDefault();
                    const selectedItems = document.querySelectorAll('.file-item.selected');
                    if (selectedItems.length === 0){
                        await showAlert('è¯·åœ¨åˆ—è¡¨ä¸­é€‰æ‹©é¡¹ç›®');
                        return;
                    }
                    selectedItems.forEach(function(fileItem){
                        const fileName = fileItem.getAttribute('data-filename');
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'selected_files';
                        hiddenInput.value = fileName;
                        e.target.appendChild(hiddenInput);
                    });
                    form.submit();
                });
            }
            attachBatchHandler('batch_download_form');
            attachBatchHandler('batch_delete_form');
            attachBatchHandler('batch_move_form');

            // å•å‡»æ–‡ä»¶è¡Œé€‰ä¸­(åªå…è®¸é€‰æ‹©æ–‡ä»¶,ä¸å…è®¸é€‰æ‹©æ–‡ä»¶å¤¹)
            document.querySelectorAll('.file-item:not(.folder-item)').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    if (e.target.closest('.rename-button')
                     || e.target.closest('.rename-form')
                     || e.target.closest('.open-button')) {
                        return;
                    }
                    item.classList.toggle('selected');
                });
            });
        });

        function showRenameForm(event, oldName, type) {
            event.stopPropagation();
            const parentLi = event.target.closest('li');
            const renameForm = parentLi.querySelector('.rename-form');
            if (renameForm) {
                renameForm.style.display = 'inline-block';
            }
        }

        function cancelRename(event) {
            event.stopPropagation();
            const form = event.target.closest('.rename-form');
            form.style.display = 'none';
        }

        // æ‰¹é‡æ“ä½œç›¸å…³å‡½æ•°
        function getSelectedFiles() {
            const selectedItems = document.querySelectorAll('.file-item.selected');
            return Array.from(selectedItems).map(item => ({
                filename: item.getAttribute('data-filename'),
                isPersonal: item.getAttribute('data-owner') !== 'shared',
                owner: item.getAttribute('data-owner')
            }));
        }

        // æ‰¹é‡ç§»åŠ¨
        async function openBatchMoveModal() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                await showAlert('è¯·é€‰æ‹©è¦ç§»åŠ¨çš„æ–‡ä»¶');
                return;
            }
            
            const form = document.getElementById('batchMoveForm');
            // æ¸…é™¤ä¹‹å‰çš„hidden inputs
            form.querySelectorAll('input[name="selected_files"]').forEach(input => input.remove());
            
            // æ·»åŠ æ–°çš„hidden inputs
            selectedFiles.forEach(file => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_files';
                input.value = file.filename;
                form.appendChild(input);
            });
            
            document.getElementById('batchMoveModal').style.display = 'flex';
        }

        function closeBatchMoveModal() {
            document.getElementById('batchMoveModal').style.display = 'none';
        }

        // æ‰¹é‡ä¸‹è½½
        async function batchDownload() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                await showAlert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶æƒé™
            const personalFiles = selectedFiles.filter(f => f.isPersonal);
            if (personalFiles.length === 0) {
                submitBatchDownload();
                return;
            }
            
            const owners = new Set(personalFiles.map(f => f.owner));
            if (owners.size > 1) {
                await showAlert('é€‰ä¸­çš„æ–‡ä»¶å±äºä¸åŒç”¨æˆ·,æ— æ³•æ‰¹é‡ä¸‹è½½');
                return;
            }
            
            // å¼¹å‡ºéªŒè¯æ¡†
            document.getElementById('batchAuthTitle').textContent = 'éªŒè¯ä¸‹è½½æƒé™';
            const authForm = document.getElementById('batchAuthForm');
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                const username = authForm.owner_user.value;
                if (username === Array.from(owners)[0]) {
                    closeBatchAuthModal();
                    submitBatchDownload(username);
                } else {
                    alert('ç”¨æˆ·åéªŒè¯å¤±è´¥');
                }
            };
            document.getElementById('batchAuthModal').style.display = 'flex';
        }

        function submitBatchDownload(username = '') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("download_selected") }}';
            
            // æ·»åŠ å½“å‰ç›®å½•
            const dirInput = document.createElement('input');
            dirInput.type = 'hidden';
            dirInput.name = 'dir';
            dirInput.value = '{{ current_dir }}';
            form.appendChild(dirInput);
            
            // æ·»åŠ ç”¨æˆ·å(å¦‚æœæœ‰)
            if (username) {
                const userInput = document.createElement('input');
                userInput.type = 'hidden';
                userInput.name = 'owner_user';
                userInput.value = username;
                form.appendChild(userInput);
            }
            
            // æ·»åŠ é€‰ä¸­çš„æ–‡ä»¶
            getSelectedFiles().forEach(file => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_files';
                input.value = file.filename;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // æ‰¹é‡åˆ é™¤
        async function batchDelete() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                await showAlert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶æƒé™
            const personalFiles = selectedFiles.filter(f => f.isPersonal);
            if (personalFiles.length === 0) {
                // å…¨æ˜¯å…±äº«æ–‡ä»¶,ç¡®è®¤ååˆ é™¤
                if (await showConfirm('ç¡®è®¤åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    submitBatchDelete();
                }
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦éƒ½æ˜¯åŒä¸€ä¸ªç”¨æˆ·çš„æ–‡ä»¶
            const owners = new Set(personalFiles.map(f => f.owner));
            if (owners.size > 1) {
                alert('é€‰ä¸­çš„æ–‡ä»¶å±äºä¸åŒç”¨æˆ·,æ— æ³•æ‰¹é‡åˆ é™¤');
                return;
            }
            
            // å¼¹å‡ºéªŒè¯æ¡†
            document.getElementById('batchAuthTitle').textContent = 'éªŒè¯åˆ é™¤æƒé™';
            const authForm = document.getElementById('batchAuthForm');
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                const username = authForm.owner_user.value;
                if (username === Array.from(owners)[0]) {
                    if (await showConfirm('ç¡®è®¤åˆ é™¤é€‰ä¸­çš„æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        closeBatchAuthModal();
                        submitBatchDelete(username);
                    }
                } else {
                    alert('ç”¨æˆ·åéªŒè¯å¤±è´¥');
                }
            };
            document.getElementById('batchAuthModal').style.display = 'flex';
        }

        function submitBatchDelete(username = '') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("delete_selected") }}';
            
            // æ·»åŠ å½“å‰ç›®å½•
            const dirInput = document.createElement('input');
            dirInput.type = 'hidden';
            dirInput.name = 'dir';
            dirInput.value = '{{ current_dir }}';
            form.appendChild(dirInput);
            
            // æ·»åŠ ç”¨æˆ·å(å¦‚æœæœ‰)
            if (username) {
                const userInput = document.createElement('input');
                userInput.type = 'hidden';
                userInput.name = 'owner_user';
                userInput.value = username;
                form.appendChild(userInput);
            }
            
            // æ·»åŠ é€‰ä¸­çš„æ–‡ä»¶
            getSelectedFiles().forEach(file => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_files';
                input.value = file.filename;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function closeBatchAuthModal() {
            document.getElementById('batchAuthModal').style.display = 'none';
        }

        // é€šç”¨æ¨¡æ€æ¡†å‡½æ•°
        let modalResolve = null;

        function showModal(title, message, showCancel = false) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageContent').textContent = message;
                document.getElementById('messageCancelBtn').style.display = showCancel ? 'block' : 'none';
                document.getElementById('messageModal').style.display = 'flex';
            });
        }

        function closeMessageModal(result) {
            document.getElementById('messageModal').style.display = 'none';
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }

        // æ›¿æ¢alert
        async function showAlert(message) {
            await showModal('æç¤º', message, false);
        }

        // æ›¿æ¢confirm
        async function showConfirm(message) {
            return await showModal('ç¡®è®¤', message, true);
        }

        // éªŒè¯å¹¶ä¸‹è½½ä¸ªäººæ–‡ä»¶
        async function verifyAndDownload(filename, owner) {
            document.getElementById('batchAuthTitle').textContent = 'éªŒè¯ä¸‹è½½æƒé™';
            const authForm = document.getElementById('batchAuthForm');
            
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                const username = authForm.owner_user.value;
                if (username === owner) {
                    closeBatchAuthModal();
                    // æ‰§è¡Œä¸‹è½½
                    window.location.href = `{{ url_for('download_file', filepath='') }}${
                        '{{ current_dir }}' ? '{{ current_dir }}/' : ''
                    }${filename}`;
                } else {
                    await showAlert('ç”¨æˆ·åéªŒè¯å¤±è´¥');
                }
            };
            
            document.getElementById('batchAuthModal').style.display = 'flex';
        }

        // éªŒè¯å¹¶åˆ é™¤ä¸ªäººæ–‡ä»¶
        async function verifyAndDelete(filename, owner) {
            document.getElementById('batchAuthTitle').textContent = 'éªŒè¯åˆ é™¤æƒé™';
            const authForm = document.getElementById('batchAuthForm');
            
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                const username = authForm.owner_user.value;
                if (username === owner) {
                    if (await showConfirm('ç¡®è®¤åˆ é™¤æ­¤æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        closeBatchAuthModal();
                        // æ‰§è¡Œåˆ é™¤
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = `{{ url_for('delete_item', filepath='') }}${
                            '{{ current_dir }}' ? '{{ current_dir }}/' : ''
                        }${filename}`;
                        
                        const userInput = document.createElement('input');
                        userInput.type = 'hidden';
                        userInput.name = 'owner_user';
                        userInput.value = username;
                        form.appendChild(userInput);
                        
                        document.body.appendChild(form);
                        form.submit();
                        document.body.removeChild(form);
                    }
                } else {
                    await showAlert('ç”¨æˆ·åéªŒè¯å¤±è´¥');
                }
            };
            
            document.getElementById('batchAuthModal').style.display = 'flex';
        }

        // éªŒè¯å¹¶åˆ é™¤æ–‡ä»¶å¤¹
        async function verifyAndDeleteFolder(folderPath, folderName) {
            try {
                // è·å–æ–‡ä»¶å¤¹å†…å®¹
                const response = await fetch(`{{ url_for('get_folder_contents', folder_path='') }}${folderPath}`);
                const data = await response.json();
                
                if (data.error) {
                    await showAlert(data.error);
                    return;
                }
                
                // æ„å»ºæ˜¾ç¤ºå†…å®¹
                let message = `æ–‡ä»¶å¤¹ "${folderName}" åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š\n\n`;
                data.contents.forEach(file => {
                    message += `${file.name} (${file.owner === 'shared' ? 'å…±äº«æ–‡ä»¶' : 'ä¸ªäººæ–‡ä»¶-' + file.owner})\n`;
                });
                
                const owners = Object.keys(data.personal_files);
                
                if (owners.length === 0) {
                    // å…¨æ˜¯å…±äº«æ–‡ä»¶
                    if (await showConfirm(message + '\nç¡®è®¤åˆ é™¤è¿™äº›æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        submitFolderDelete(folderPath);
                    }
                } else if (owners.length === 1) {
                    // å­˜åœ¨ä¸€ä¸ªç”¨æˆ·çš„ä¸ªäººæ–‡ä»¶
                    message += `\næ–‡ä»¶å¤¹ä¸­åŒ…å«ç”¨æˆ· "${owners[0]}" çš„ä¸ªäººæ–‡ä»¶ï¼Œè¯·è¾“å…¥ç”¨æˆ·åéªŒè¯ï¼š`;
                    
                    document.getElementById('batchAuthTitle').textContent = 'éªŒè¯åˆ é™¤æƒé™';
                    const authForm = document.getElementById('batchAuthForm');
                    
                    authForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const username = authForm.owner_user.value;
                        if (username === owners[0]) {
                            if (await showConfirm('ç¡®è®¤åˆ é™¤æ­¤æ–‡ä»¶å¤¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                                closeBatchAuthModal();
                                submitFolderDelete(folderPath, username);
                            }
                        } else {
                            await showAlert('ç”¨æˆ·åéªŒè¯å¤±è´¥');
                        }
                    };
                    
                    document.getElementById('batchAuthModal').style.display = 'flex';
                } else {
                    // å­˜åœ¨å¤šä¸ªç”¨æˆ·çš„ä¸ªäººæ–‡ä»¶
                    await showAlert(`æ–‡ä»¶å¤¹ä¸­åŒ…å«å¤šä¸ªç”¨æˆ·(${owners.join(', ')})çš„ä¸ªäººæ–‡ä»¶ï¼Œæ— æ³•åˆ é™¤ã€‚`);
                }
            } catch (error) {
                await showAlert('è·å–æ–‡ä»¶å¤¹å†…å®¹å¤±è´¥: ' + error);
            }
        }

        function submitFolderDelete(folderPath, username = '') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `{{ url_for('delete_item', filepath='') }}${folderPath}`;
            
            if (username) {
                const userInput = document.createElement('input');
                userInput.type = 'hidden';
                userInput.name = 'owner_user';
                userInput.value = username;
                form.appendChild(userInput);
            }
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // ç¡®è®¤åˆ é™¤å…±äº«æ–‡ä»¶
        async function confirmSharedFileDelete(filepath, filename) {
            if (await showConfirm(`ç¡®è®¤åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `{{ url_for('delete_item', filepath='') }}${filepath}`;
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            }
        }
    </script>
</head>
<body>
<!-- å¤´éƒ¨å¸ƒå±€ï¼šæ’åº->æœç´¢å±…ä¸­->æ–°å»º->ä¸Šä¼  -->
<div class="header">
    <!-- ä¿®æ”¹ç½‘ç«™åç§° -->
    <div class="site-title">Abyss' MD Store</div>
    
    <div class="sort-container">
        <span>æ’åº:</span>
        <button class="btn" onclick="changeSort('name')">åç§°</button>
        <button class="btn" onclick="changeSort('upload_time')">ä¸Šä¼ æ—¶é—´</button>
        <button class="btn" onclick="changeSort('edit_time')">ç¼–è¾‘æ—¶é—´</button>
    </div>
    <div class="search-container">
        <input type="text" id="search_input" placeholder="æœç´¢..." value="{{ search_keyword }}">
        <button class="btn" onclick="doSearch()">æœç´¢</button>
    </div>
    <a href="javascript:void(0)" onclick="openNewFileModal()" class="btn">æ–°å»ºMDæ–‡ä»¶</a>
    <a href="javascript:void(0)" onclick="openUploadModal()" class="btn primary">ä¸Šä¼ æ–‡ä»¶</a>
</div>

<div class="main">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
        <!-- å›ºå®šåœ¨é¡¶éƒ¨çš„æ“ä½œåŒºåŸŸ -->
        <div class="operations-area">
            <!-- æ·»åŠ é¢åŒ…å±‘å¯¼èˆª -->
            <div class="breadcrumb">
                <a href="{{ url_for('index') }}" class="breadcrumb-item">æ ¹ç›®å½•</a>
                {% if current_dir %}
                    {% set path_parts = current_dir.split('/') %}
                    {% set current_path = [] %}
                    {% for part in path_parts if part %}
                        {% set _ = current_path.append(part) %}
                        <span class="breadcrumb-separator">/</span>
                        {% if loop.last %}
                            <span class="breadcrumb-item current">{{ part }}</span>
                        {% else %}
                            <a href="{{ url_for('index', dir='/'.join(current_path)) }}" class="breadcrumb-item">{{ part }}</a>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>

            <div class="folder-nav">
                {% if current_dir != '' %}
                <a href="{{ url_for('index', dir=parent_dir) }}" class="btn back-button">è¿”å›ä¸Šçº§ç›®å½•</a>
                {% endif %}
            </div>
            <div class="batch-operations">
                <button onclick="openNewFolderModal()" class="btn">æ–°å»ºæ–‡ä»¶å¤¹</button>
                <button onclick="batchDownload()" class="btn primary">æ‰¹é‡ä¸‹è½½</button>
                <button onclick="openBatchMoveModal()" class="btn">æ‰¹é‡ç§»åŠ¨</button>
                <button onclick="batchDelete()" class="btn danger">æ‰¹é‡åˆ é™¤</button>
            </div>
        </div>

        <!-- å¯æ»šåŠ¨çš„æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ -->
        <div class="files-area">
            <div class="folder-list">
                <ul>
                {% for folder in folders %}
                    <li class="file-item folder-item" data-filename="{{ folder.name if folder is mapping else folder }}">
                        <div class="file-icon">ğŸ“</div>
                        <div class="file-info">
                            <div class="file-name">{{ folder.name if folder is mapping else folder }}</div>
                        </div>
                        
                        <div class="file-actions">
                            <a href="{{ url_for('index', dir=folder.path if folder is mapping else (current_dir ~ '/' ~ folder if current_dir else folder)) }}" class="btn open-button">æ‰“å¼€</a>
                            <button class="btn rename-button" onclick="showRenameModal('{{ folder.name if folder is mapping else folder }}', 'folder')">é‡å‘½å</button>
                            <button class="btn danger" onclick="verifyAndDeleteFolder('{{ current_dir+'/'+folder if current_dir else folder }}', '{{ folder.name if folder is mapping else folder }}')">åˆ é™¤</button>
                        </div>

                        <!-- é‡å‘½åè¡¨å• -->
                        <form class="rename-form" action="{{ url_for('rename_item') }}" method="post" style="display:none;">
                            <input type="hidden" name="dir" value="{{ current_dir }}">
                            <input type="hidden" name="old_name" value="{{ folder.name if folder is mapping else folder }}">
                            <input type="hidden" name="type" value="folder">
                            <input type="text" name="new_name" placeholder="æ–°åç§°" class="input-text short-input" required>
                            <button type="submit" class="btn">ç¡®å®š</button>
                            <button type="button" class="btn" onclick="cancelRename(event)">å–æ¶ˆ</button>
                        </form>
                    </li>
                {% endfor %}
                </ul>
            </div>
            <hr>
            <div class="file-list">
                <ul>
                {% for f in files %}
                    <li class="file-item" data-filename="{{ f.name }}" data-owner="{{ f.owner }}" data-ext="{{ f.extension }}">
                        <div class="file-icon">
                            {% if f.extension == '.md' %}ğŸ“
                            {% elif f.extension in ['.jpg', '.jpeg', '.png', '.gif'] %}ğŸ–¼ï¸
                            {% elif f.extension in ['.doc', '.docx', '.pdf'] %}ğŸ“„
                            {% elif f.extension in ['.xls', '.xlsx', '.csv'] %}ğŸ“Š
                            {% elif f.extension in ['.zip', '.rar', '.7z'] %}ğŸ“¦
                            {% else %}ğŸ“
                            {% endif %}
                        </div>
                        <div class="file-info">
                            <div class="file-name">{{ f.original_name }}</div>
                            <div class="file-meta">
                                ä¸Šä¼ : {{ f.upload_time }} | ç¼–è¾‘: {{ f.edit_time }}
                            </div>
                        </div>
                        
                        <div class="file-actions">
                            {% if f.name.lower().endswith('.md') %}
                                <a href="{{ url_for('index', dir=f.path, selected=f.name) }}" class="btn open-button">æ‰“å¼€</a>
                            {% endif %}
                            {% if f.owner == 'shared' %}
                                <a class="btn" href="{{ url_for('download_file', filepath=(current_dir+'/'+f.name if current_dir else f.name)) }}">ä¸‹è½½</a>
                            {% else %}
                                <button class="btn" onclick="verifyAndDownload('{{ f.name }}', '{{ f.owner }}')">ä¸‹è½½</button>
                            {% endif %}
                            <button class="btn rename-button" onclick="showRenameModal('{{ f.name }}', 'file')">é‡å‘½å</button>
                            {% if f.owner == 'shared' %}
                                <button class="btn danger" onclick="confirmSharedFileDelete('{{ current_dir+'/'+f.name if current_dir else f.name }}', '{{ f.name }}')">åˆ é™¤</button>
                            {% else %}
                                <button class="btn danger" onclick="verifyAndDelete('{{ f.name }}', '{{ f.owner }}')">åˆ é™¤</button>
                            {% endif %}
                        </div>
                        
                        <!-- é‡å‘½åè¡¨å• -->
                        <form class="rename-form" action="{{ url_for('rename_item') }}" method="post" style="display:none;">
                            <input type="hidden" name="dir" value="{{ current_dir }}">
                            <input type="hidden" name="old_name" value="{{ f.name }}">
                            <input type="hidden" name="type" value="file">
                            <input type="text" name="new_name" placeholder="æ–°åç§°" class="input-text short-input" required>
                            <button type="submit" class="btn">ç¡®å®š</button>
                            <button type="button" class="btn" onclick="cancelRename(event)">å–æ¶ˆ</button>
                        </form>
                    </li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ (3/4) -->
    <div class="right-panel">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <ul class="flashes">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {% if is_new_file %}
            <div class="top-line">
                <div class="file-title">æ–°å»ºMDæ–‡ä»¶</div>
            </div>
            <div class="editor-container" style="width:100%;">
                <div class="upload-container" style="margin-top:20px; height:100%; display:flex; flex-direction:column; width:100%; margin:0;">
                    <form method="post" action="{{ url_for('create_new_file') }}"
                          style="display:flex; flex-direction:column; height:100%;">
                        <input type="hidden" name="dir" value="{{ current_dir }}">

                        <label for="new_filename">æ–‡ä»¶å:</label>
                        <input type="text" name="new_filename" class="input-text short-input" placeholder="å¦‚: æˆ‘çš„æ–‡æ¡£.md" required style="margin-bottom:20px;">

                        <div class="owner-type">
                            <label><input type="radio" name="owner_type" value="shared" checked> å…±äº«æ–‡ä»¶</label>
                            <label><input type="radio" name="owner_type" value="personal"> ä¸ªäººæ–‡ä»¶</label>
                        </div>
                        <label for="owner_user">ä¸ªäººæ–‡ä»¶æ—¶è¯·å¡«ç”¨æˆ·å(å¦åˆ™ç•™ç©º)</label>
                        <input type="text" name="owner_user" class="input-text short-input" style="margin-bottom:20px;">

                        <label for="content">å†…å®¹:</label>
                        <textarea name="content" class="textarea" style="flex:1 1 auto;"></textarea>

                        <div style="margin-top:20px;">
                            <button type="submit" class="btn primary">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            </div>

        {% elif selected_file %}
            <div class="top-line">
                <div class="file-title">{{ selected_file_original_name }}</div>
                <div class="file-actions">
                    {% if not need_auth_to_view %}
                        <button class="btn primary" id="edit_button" onclick="startEditing()">ç¼–è¾‘</button>
                        <div id="edit_controls" style="display:none;">
                            <button class="btn primary" form="edit_form">ä¿å­˜</button>
                            <button class="btn" type="button" onclick="cancelEditing()">å–æ¶ˆ</button>
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if need_auth_to_view %}
                <p>è¿™æ˜¯ä¸ªäººæ–‡ä»¶ï¼Œè¯·è¾“å…¥ç”¨æˆ·åæŸ¥çœ‹ï¼š</p>
                <form method="get" action="">
                    <input type="hidden" name="dir" value="{{ current_dir }}">
                    <input type="hidden" name="selected" value="{{ selected_file }}">
                    <input type="text" name="auth_user" class="input-text" placeholder="ç”¨æˆ·å" required>
                    <button type="submit" class="btn primary">ç¡®è®¤</button>
                </form>
            {% else %}
                <div class="editor-container">
                    <!-- é»˜è®¤æ˜¾ç¤ºé¢„è§ˆ -->
                    <div id="file_content_view" style="display:block;">
                        <div class="md-content" style="margin-bottom:10px;">
                            {{ selected_file_html|safe }}
                        </div>
                    </div>
                    <!-- ç¼–è¾‘è¡¨å•é»˜è®¤éšè— -->
                    <form id="edit_form" action="{{ url_for('update_file') }}" method="post" style="display:none;">
                        <input type="hidden" name="dir" value="{{ current_dir }}">
                        <input type="hidden" name="filename" value="{{ selected_file }}">
                        <input type="hidden" name="owner_user" value="">
                        <textarea name="content" class="textarea">{{ selected_file_content }}</textarea>
                    </form>
                </div>
            {% endif %}
        {% else %}
            <p>è¯·é€‰æ‹©ä¸€ä¸ªMDæ–‡ä»¶ä»¥æŸ¥çœ‹å’Œç¼–è¾‘ï¼Œæˆ–ä½¿ç”¨å³ä¸Šè§’"æ–°å»ºMDæ–‡ä»¶"è¿›è¡Œæ–°å»ºã€‚</p>
        {% endif %}
    </div>
</div>

<div class="footer">
    Abyss' MD Store - Version 1.1.3
</div>

<!-- åœ¨bodyæœ«å°¾æ·»åŠ ä¸Šä¼ æ¨¡æ€æ¡† -->
<div id="uploadModal" class="modal">
  <div class="modal-content">
    <h2>ä¸Šä¼ æ–‡ä»¶</h2>
    
    <!-- å•ç‹¬çš„æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-area" id="dropZone">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
      <div class="upload-subtext">æ”¯æŒæ‰€æœ‰ç±»å‹æ–‡ä»¶</div>
    </div>

    <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
      <input type="hidden" name="dir" value="{{ current_dir }}">
      <input type="file" name="file" id="fileInput" class="file-input" multiple>
      
      <!-- ä¸Šä¼ é€‰é¡¹åŒºåŸŸ -->
      <div class="upload-options">
        <div class="owner-type-section">
          <div class="section-title">æ–‡ä»¶ç±»å‹</div>
          <div class="owner-type">
            <label><input type="radio" name="owner_type" value="shared" checked> å…±äº«æ–‡ä»¶</label>
            <label><input type="radio" name="owner_type" value="personal"> ä¸ªäººæ–‡ä»¶</label>
          </div>
        </div>

        <div id="upload_owner_input" style="display:none;">
          <label>ç”¨æˆ·å:</label>
          <input type="text" name="owner_user" class="input-text">
        </div>
      </div>

      <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
      <div class="file-preview" style="display:none;">
        <div class="preview-title">å¾…ä¸Šä¼ æ–‡ä»¶:</div>
        <div id="fileList"></div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="modal-buttons">
        <button type="submit" class="btn primary">ä¸Šä¼ </button>
        <button type="button" class="btn" onclick="closeUploadModal()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- åœ¨bodyæœ«å°¾æ·»åŠ æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="newFileModal" class="modal">
  <div class="modal-content">
    <h2>æ–°å»ºMDæ–‡ä»¶</h2>
    
    <form id="newFileForm" action="{{ url_for('create_new_file') }}" method="post">
      <input type="hidden" name="dir" value="{{ current_dir }}">
      
      <!-- æ–‡ä»¶åè¾“å…¥ -->
      <div class="input-group">
        <label>æ–‡ä»¶å:</label>
        <input type="text" name="new_filename" class="input-text" placeholder="å¦‚: æˆ‘çš„æ–‡æ¡£.md" required>
      </div>
      
      <!-- æ–‡ä»¶ç±»å‹é€‰æ‹© -->
      <div class="owner-type-section">
        <div class="section-title">æ–‡ä»¶ç±»å‹</div>
        <div class="owner-type">
          <label><input type="radio" name="owner_type" value="shared" checked> å…±äº«æ–‡ä»¶</label>
          <label><input type="radio" name="owner_type" value="personal"> ä¸ªäººæ–‡ä»¶</label>
        </div>
      </div>

      <!-- ç”¨æˆ·åè¾“å…¥(é»˜è®¤éšè—) -->
      <div id="new_file_owner_input" style="display:none;">
        <label>ç”¨æˆ·å:</label>
        <input type="text" name="owner_user" class="input-text">
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="modal-buttons">
        <button type="submit" class="btn primary">åˆ›å»º</button>
        <button type="button" class="btn" onclick="closeNewFileModal()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- æ·»åŠ æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
<div id="newFolderModal" class="modal">
  <div class="modal-content">
    <h2>æ–°å»ºæ–‡ä»¶å¤¹</h2>
    
    <form id="newFolderForm" action="{{ url_for('mkdir') }}" method="post">
      <input type="hidden" name="dir" value="{{ current_dir }}">
      
      <!-- æ–‡ä»¶å¤¹åç§°è¾“å…¥ -->
      <div class="input-group">
        <label>æ–‡ä»¶å¤¹åç§°:</label>
        <input type="text" name="folder_name" class="input-text" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°" required>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="modal-buttons">
        <button type="submit" class="btn primary">åˆ›å»º</button>
        <button type="button" class="btn" onclick="closeNewFolderModal()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- æ‰¹é‡ç§»åŠ¨æ¨¡æ€æ¡† -->
<div id="batchMoveModal" class="modal">
  <div class="modal-content">
    <h2>æ‰¹é‡ç§»åŠ¨æ–‡ä»¶</h2>
    <form id="batchMoveForm" action="{{ url_for('move_selected') }}" method="post">
      <input type="hidden" name="dir" value="{{ current_dir }}">
      <div class="input-group">
        <label>é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹:</label>
        <select name="target_dir" class="input-text" required>
          <option value="/">æ ¹ç›®å½•</option>
          {% for d in all_dirs %}
          {% if d != '/' %}
          <option value="{{ d }}">{{ d }}</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="modal-buttons">
        <button type="submit" class="btn primary">ç§»åŠ¨</button>
        <button type="button" class="btn" onclick="closeBatchMoveModal()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- æ‰¹é‡ä¸‹è½½/åˆ é™¤éªŒè¯æ¨¡æ€æ¡† -->
<div id="batchAuthModal" class="modal">
  <div class="modal-content">
    <h2 id="batchAuthTitle">éªŒè¯ç”¨æˆ·</h2>
    <form id="batchAuthForm">
      <div class="input-group">
        <label>è¯·è¾“å…¥ç”¨æˆ·å:</label>
        <input type="text" name="owner_user" class="input-text" required>
      </div>
      <div class="modal-buttons">
        <button type="submit" class="btn primary">ç¡®è®¤</button>
        <button type="button" class="btn" onclick="closeBatchAuthModal()">å–æ¶ˆ</button>
      </div>
    </form>
  </div>
</div>

<!-- é€šç”¨æ¶ˆæ¯æ¨¡æ€æ¡† -->
<div id="messageModal" class="modal">
  <div class="modal-content">
    <h2 id="messageTitle">æç¤º</h2>
    <div class="message-content" id="messageContent"></div>
    <div class="modal-buttons">
      <button class="btn primary" onclick="closeMessageModal(true)">ç¡®å®š</button>
      <button class="btn" onclick="closeMessageModal(false)" id="messageCancelBtn" style="display:none;">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- æ·»åŠ é‡å‘½åæ¨¡æ€æ¡† -->
<div id="renameModal" class="modal">
    <div class="modal-content">
        <h2>é‡å‘½å</h2>
        <form id="renameForm" action="{{ url_for('rename_item') }}" method="post">
            <input type="hidden" name="dir" value="{{ current_dir }}">
            <input type="hidden" name="old_name" id="rename_old_name">
            <input type="hidden" name="type" id="rename_type">
            
            <div class="input-group">
                <label>æ–°åç§°:</label>
                <div class="rename-input-group">
                    <input type="text" id="rename_new_name" name="new_name" class="input-text" required>
                    <span id="rename_extension" class="extension-label"></span>
                </div>
            </div>

            <div class="modal-buttons">
                <button type="submit" class="btn primary">ç¡®è®¤</button>
                <button type="button" class="btn" onclick="closeRenameModal()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
</div>

<!-- æ·»åŠ ç›¸å…³JavaScript -->
<script>
// æ‰“å¼€ä¸Šä¼ æ¨¡æ€æ¡†
function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'flex';
}

// å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

// æ‰“å¼€æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡†
function openNewFileModal() {
    document.getElementById('newFileModal').style.display = 'flex';
}

// å…³é—­æ–°å»ºæ–‡ä»¶æ¨¡æ€æ¡†
function closeNewFileModal() {
    document.getElementById('newFileModal').style.display = 'none';
}

// æ‰“å¼€æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†
function openNewFolderModal() {
    document.getElementById('newFolderModal').style.display = 'flex';
}

// å…³é—­æ–°å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†
function closeNewFolderModal() {
    document.getElementById('newFolderModal').style.display = 'none';
}

// ç­‰å¾…DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    // å¤„ç†ä¸ªäºº/å…±äº«æ–‡ä»¶é€‰æ‹© (ä¸Šä¼ æ–‡ä»¶)
    document.querySelectorAll('#uploadForm input[name="owner_type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const ownerInput = document.getElementById('upload_owner_input');
            ownerInput.style.display = e.target.value === 'personal' ? 'block' : 'none';
        });
    });

    // å¤„ç†ä¸ªäºº/å…±äº«æ–‡ä»¶é€‰æ‹© (æ–°å»ºæ–‡ä»¶)
    document.querySelectorAll('#newFileForm input[name="owner_type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const ownerInput = document.getElementById('new_file_owner_input');
            ownerInput.style.display = e.target.value === 'personal' ? 'block' : 'none';
        });
    });

    // å¤„ç†æ‹–æ‹½ä¸Šä¼ 
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadForm = document.getElementById('uploadForm');

    // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    // å¤„ç†æ‹–æ‹½çŠ¶æ€çš„è§†è§‰åé¦ˆ
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    // å¤„ç†æ–‡ä»¶æ‹–æ”¾
    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', () => {
        handleFiles(fileInput.files);
    });

    // å¤„ç†è¡¨å•æäº¤
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadForm);
        
        try {
            const response = await fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                await showAlert('ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            await showAlert('ä¸Šä¼ å‡ºé”™: ' + error);
        }
    });
});

// å¤„ç†é€‰ä¸­çš„æ–‡ä»¶
async function handleFiles(files) {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    let hasFiles = false;

    for (const file of files) {
        hasFiles = true;
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
            <div class="preview-item-name">${file.name}</div>
            <div class="preview-item-size">${formatFileSize(file.size)}</div>
        `;
        fileList.appendChild(item);
    }

    if (hasFiles) {
        document.querySelector('.file-preview').style.display = 'block';
        // æ›´æ–°æ–‡ä»¶è¾“å…¥æ¡†çš„æ–‡ä»¶
        const dataTransfer = new DataTransfer();
        Array.from(files).forEach(file => {
            dataTransfer.items.add(file);
        });
        fileInput.files = dataTransfer.files;
    } else {
        document.querySelector('.file-preview').style.display = 'none';
    }
}

// æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ‰“å¼€é‡å‘½åæ¨¡æ€æ¡†
function showRenameModal(oldName, type) {
    const modal = document.getElementById('renameModal');
    const oldNameInput = document.getElementById('rename_old_name');
    const typeInput = document.getElementById('rename_type');
    const newNameInput = document.getElementById('rename_new_name');
    const extensionSpan = document.getElementById('rename_extension');
    
    // è®¾ç½®è¡¨å•å­—æ®µ
    oldNameInput.value = oldName;
    typeInput.value = type;
    
    if (type === 'file') {
        // å¦‚æœæ˜¯æ–‡ä»¶ï¼Œåˆ†ç¦»æ–‡ä»¶åå’Œæ‰©å±•å
        const extension = oldName.substring(oldName.lastIndexOf('.'));
        const nameWithoutExt = oldName.substring(0, oldName.lastIndexOf('.'));
        newNameInput.value = nameWithoutExt;
        extensionSpan.textContent = extension;
        extensionSpan.style.display = 'inline';
    } else {
        // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œä¸æ˜¾ç¤ºæ‰©å±•å
        newNameInput.value = oldName;
        extensionSpan.style.display = 'none';
    }
    
    modal.style.display = 'flex';
}

// å…³é—­é‡å‘½åæ¨¡æ€æ¡†
function closeRenameModal() {
    document.getElementById('renameModal').style.display = 'none';
}

// éªŒè¯é‡å‘½åè¡¨å•
document.getElementById('renameForm').addEventListener('submit', function(e) {
    const newName = document.getElementById('rename_new_name').value;
    if (!newName || newName.includes('/') || newName.includes('\\')) {
        e.preventDefault();
        alert('æ–‡ä»¶åä¸èƒ½ä¸ºç©ºæˆ–åŒ…å«ç‰¹æ®Šå­—ç¬¦');
    }
});
</script>
</body>
</html>
